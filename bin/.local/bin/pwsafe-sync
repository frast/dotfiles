#!/bin/bash
#
# sync-passwordsafe.sh
# Bidirektionale Synchronisation von PasswordSafe-Dateien mit OneDrive
# für Debian Stable (rclone >= 1.55 erforderlich)
#

# Abbruch bei Fehlern
set -e

# Pfade
LOCAL_DIR="$HOME/Dokumente/Passwords"
REMOTE_DIR="onedrive:Dokumente/Passwords"

# Prüfen, ob rclone verfügbar ist
if ! command -v rclone >/dev/null 2>&1; then
    echo "Fehler: rclone ist nicht installiert."
    echo "Bitte mit 'sudo apt install rclone' installieren."
    exit 1
fi

# Sicherstellen, dass das lokale Verzeichnis existiert
if [ ! -d "$LOCAL_DIR" ]; then
    echo "Fehler: Lokales Verzeichnis '$LOCAL_DIR' existiert nicht."
    exit 1
fi

echo "=== $(date '+%Y-%m-%d %H:%M:%S') ==="
echo "Starte bidirektionale Synchronisation ..."
echo "Lokaler Pfad:  $LOCAL_DIR"
echo "Remote-Pfad:  $REMOTE_DIR"

# Erster Lauf mit --resync erforderlich, danach ohne
rclone bisync "$LOCAL_DIR" "$REMOTE_DIR" \
    --max-delete 1 "$@"

echo "Synchronisation abgeschlossen."

